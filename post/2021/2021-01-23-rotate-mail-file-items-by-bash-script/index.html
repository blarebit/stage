<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>Rotate Mail File Items by Bash Script</title><link rel=stylesheet href=/css/hugo-octopress.css><link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://blarebit.io/favicon.png rel=icon><meta name=description content><meta name=keywords content><meta name=author content><meta name=generator content="Hugo 0.98.0"></head><body><header role=banner><hgroup><h1><a href=https://blarebit.io/>Blarebit</a></h1><h2>Open Source DevOps Tools, Utilities, and Libraries!</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://blarebit.io/>» Blog</option><option value=https://github.com/blarebit>» Projects</option><option value=mailto:info@blarebit.io>» Contact</option></select></fieldset><ul class=main-navigation><li><a href=https://blarebit.io/ title=Blog>Blog</a></li><li><a href=https://github.com/blarebit title=Projects rel="noopener noreferrer">Projects</a></li><li><a href=mailto:info@blarebit.io title=Contact rel="noopener noreferrer">Contact</a></li></ul><ul class=subscription><a href=https://blarebit.io/index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://blarebit.io/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Jan 23, 2021
- 3 minute read
- <a class=label href=https://blarebit.io/categories/code/>Code </a><a class=label href=https://blarebit.io/categories/bash/>Bash </a><a class=label href=https://blarebit.io/categories/mail/>Mail</a></p><h1 class=entry-title>Rotate Mail File Items by Bash Script</h1></header><div class=entry-content><h1 id=rotate-mail-file-items-by-bash-script>Rotate Mail File Items by Bash Script</h1><p>On a server when you install an MTA, and it can send and receives emails,
it creates a file under <code>/var/spool/mail</code> for each user.
Generally, it appends data into the end of the file when a new email received.
During the time, this file will be growing and become bigger and bigger, so
it depends on the quota of users how much data it can receive.
Normally, you can put a quota to avoid data size to be exceeded.</p><p>What if that you want to have a rotation on the mail file of a user?
I know maybe you think that it&rsquo;s not a useful case, but in our case it
was useful. For example, alert logs are not only be sent via a messenger, but it also
is sent by an email. So, we can rotate the email file as we know what it contains.</p><p>If you want to rotate it by a rotating tools, it&rsquo;s not going to work because each email
contains several lines of data and also, you need to rotate based on items&rsquo; received date and not lines of data.</p><p>In the <code>/var/spool/mail</code> you can see list of files which belong to each user.
For example, all emails of <code>user-1</code> is stored in <code>/var/spool/mail/user-1</code>.</p><p>To read this file, the best way is <code>mail</code> command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mail -u user-1
</span></span></code></pre></div><p>When you run the <code>mail</code> command, it puts you in an interactive environment which you need to
send commands. The first and recommended command is <code>help</code> which gives you list of available commands.</p><blockquote><p>Note: you can also use <code>mu</code> command to read and filter emails easily.</p></blockquote><p>To pass a command to a <code>mail</code> you can also use <code>echo</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#39;su&#39;</span> | mail -u user-1 -N
</span></span></code></pre></div><blockquote><p><code>su</code> stands for <code>summary</code></p></blockquote><p>To rotate logs we need to have a bash script to be executed to rotate emails:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#f92672>[[</span> <span style=color:#e6db74>&#34;</span>$#<span style=color:#e6db74>&#34;</span> -ne <span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#f92672>]]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;invalid argument!&#34;</span> <span style=color:#f92672>&amp;&amp;</span> exit <span style=color:#ae81ff>64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>user<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>max_threshold<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$2<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>current_items_count<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#39;su&#39;</span> | mail -u <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>user<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -N | grep <span style=color:#e6db74>&#39;Held&#39;</span> | awk <span style=color:#e6db74>&#39;{print $2}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[[</span> $current_items_count -lt $max_threshold <span style=color:#f92672>]]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;current </span><span style=color:#e6db74>${</span>current_items_count<span style=color:#e6db74>}</span><span style=color:#e6db74> is not more than </span><span style=color:#e6db74>${</span>2<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>&amp;&amp;</span> exit <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>remove_items<span style=color:#f92672>=</span><span style=color:#66d9ef>$((</span>$max_threshold<span style=color:#f92672>-</span>$current_items_count<span style=color:#66d9ef>))</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[[</span> $remove_items -eq <span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#f92672>]]</span> <span style=color:#f92672>&amp;&amp;</span> remove_items<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;d 1-</span><span style=color:#e6db74>${</span>remove_items#-<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> | mail -u <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>user<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -N
</span></span></code></pre></div><p>First parameter is username, and the second parameter is maximum threshold of email items.
It removes the old emails based on threshold number.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ chmod +x rotate-mail.sh
</span></span><span style=display:flex><span>$ ./rotate-mail.sh user-1 <span style=color:#ae81ff>100</span>
</span></span></code></pre></div><p>Now, you can save it in <code>rotate-mail.sh</code> file in <code>/usr/local/bin/</code> and define a cronjob for it:</p><pre tabindex=0><code>0 * * * * bash rotate-mail.sh user-1 100
</code></pre><p>You can use
<a href=https://crontab.guru/#0_*_*_*_* target=_blank rel=noopener>crontab.guru</a> to make your own schedule time.</p><p>Good resources:</p><ul><li><a href=https://mailutils.org/manual/html_section/mail.html target=_blank rel=noopener>https://mailutils.org/manual/html_section/mail.html</a></li><li><a href=https://www.commandlinux.com/man-page/man1/Mail.1.html target=_blank rel=noopener>https://www.commandlinux.com/man-page/man1/Mail.1.html</a></li></ul></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn></span></span>
<time>Jan 23, 2021</time></span></p><p class=meta><a class="basic-alignment left" href=https://blarebit.io/post/2021/2021-01-21-running-minio-cluster-in-three-different-nodes/ title="Running Minio Cluster in Three Different Nodes">Running Minio Cluster in Three Different Nodes</a>
<a class="basic-alignment right" href=https://blarebit.io/post/2021/2021-01-30-application-load-test/ title="Application Load Test">Application Load Test</a></p></footer></article></div><aside class="sidebar thirds"><section class="first odd"><p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="noopener noreferrer" href=https://github.com/blarebit title=https://github.com/blarebit><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://twitter.com/blarebit title=https://twitter.com/blarebit><i class="fa fa-twitter fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://instagram.com/blarebit title=https://instagram.com/blarebit><i class="fa fa-instagram fa-3x"></i></a></li></ul><section class=odd></section><section class=even><h1>Recent Posts</h1><ul id=recent_posts><li class=post><a href=/post/2021/2021-01-30-application-load-test/>Application Load Test</a></li><li class=post><a href=/post/2021/2021-01-23-rotate-mail-file-items-by-bash-script/>Rotate Mail File Items by Bash Script</a></li><li class=post><a href=/post/2021/2021-01-21-running-minio-cluster-in-three-different-nodes/>Running Minio Cluster in Three Different Nodes</a></li></ul></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2022 - <a href=https://blarebit.io/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>